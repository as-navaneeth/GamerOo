<%- include('../partials/admin/header.ejs') %>

    <head>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    </head>

    <style>
        .img-fluid {
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 4px;
            display: block;
            max-width: 100%;
            height: auto;
        }
        
        .image-cropper {
            max-width: 100%;
            position: relative;
        }
        
        .image-cropper img {
            border-radius: 4px;
            max-width: 100%;
        }
        
        .error-message {
            font-size: 0.875rem;
            color: #dc3545;
        }
        
        .thumbnails-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .thumbnails-container img {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Remove spinbuttons from number inputs */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
            appearance: none;
        }

        .cropper-container {
            margin-top: 15px;
        }
    </style>

    <div class="main-panel">
        <div class="content-wrapper">
            <div class="page-header">
                <h3 class="page-title">Add Product</h3>
            </div>
            <div class="row">
                <div class="col-12 grid-margin stretch-card">
                    <div class="card">
                        <div class="card-body">
                            <form id="addProductForm" class="forms-sample" enctype="multipart/form-data" >
                                <div class="form-group">
                                    <label for="name">Product Name</label>
                                    <input type="text" class="form-control" id="name" name="name" placeholder="Product Name" >
                                </div>

                                <div class="form-group">
                                    <label for="description">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="4" ></textarea>
                                </div>

                                <div class="form-group">
                                    <label for="category">Category</label>
                                    <select class="form-control" id="category" name="category" >
                                        <option value="">Select Category</option>
                                        <% if(categories && categories.length>0) {%>
                                            <%categories.forEach(category=>{ %>
                                                <option value="<%=category._id%>"><%=category.name%></option>
                                            <% });%>
                                        <%}%>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="brand">Brand</label>
                                    <select class="form-control" id="brand" name="brand" >
                                        <option value="">Select Brand</option>
                                        <% brands.forEach(brand=> { %>
                                            <option value="<%= brand._id %>"><%= brand.brandName %></option>
                                        <% }); %>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="regularPrice">Regular Price</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">₹</span>
                                        </div>
                                        <input type="number" class="form-control" id="regularPrice" name="regularPrice" min="0" step="0.01" >
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="salePrice">Sale Price</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">₹</span>
                                        </div>
                                        <input type="number" class="form-control" id="salePrice" name="salePrice" min="0" step="0.01">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="stock">Stock</label>
                                    <input type="number" class="form-control" id="stock" name="stock" min="0" >
                                </div>

                                <div class="form-group">
                                    <h4>Product Images (Up to 3)</h4>
                                    <div id="addedImagesContainer" class="thumbnails-container"></div>
                                    
                                    <div class="image-upload-container">
                                        <input class="form-control mb-2" type="file" name="productImages" id="imageInput" 
                                               accept="image/png, image/jpeg, image/jpg" multiple 
                                               onchange="handleImageSelect(event)" >
                                        <small class="text-muted">You can select up to 3 images </small>
                                        <div id="images-error" class="error-message mt-2"></div>
                                        
                                        <div id="previewContainer" class="d-flex flex-wrap gap-3 mt-3">
                                            <!-- Image previews will be added here -->
                                        </div>
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary mr-2">Submit</button>
                                    <button type="button" class="btn btn-dark" onclick="window.history.back()">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let selectedFiles = [];

        function handleImageSelect(event) {
            const files = event.target.files;
            const previewContainer = document.getElementById('previewContainer');
            const errorDiv = document.getElementById('images-error');
            
            // Clear previous error messages
            errorDiv.textContent = '';
            
            // Validate number of files
            if (files.length > 3) {
                errorDiv.textContent = 'You can only upload up to 3 images';
                event.target.value = '';
                return;
            }
            
            // Clear previous previews
            previewContainer.innerHTML = '';
            selectedFiles = [];
            
            // Process each selected file
            Array.from(files).forEach((file, index) => {
                // Validate file size
                if (file.size > 5 * 1024 * 1024) {
                    errorDiv.textContent = `${file.name} is too large. Maximum size is 5MB`;
                    return;
                }
                
                // Validate file type
                if (!['image/jpeg', 'image/jpg', 'image/png'].includes(file.type)) {
                    errorDiv.textContent = `${file.name} is not a valid image type. Only JPG, JPEG, and PNG are allowed`;
                    return;
                }
                
                selectedFiles.push(file);
                
                // Create preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewWrapper = document.createElement('div');
                    previewWrapper.className = 'position-relative';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'img-thumbnail';
                    img.style.width = '150px';
                    img.style.height = '150px';
                    img.style.objectFit = 'cover';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'btn btn-danger btn-sm position-absolute';
                    removeBtn.style.top = '5px';
                    removeBtn.style.right = '5px';
                    removeBtn.innerHTML = '×';
                    removeBtn.onclick = function() {
                        previewWrapper.remove();
                        selectedFiles = selectedFiles.filter((_, i) => i !== index);
                        
                        // Reset file input if no files remain
                        if (selectedFiles.length === 0) {
                            document.getElementById('imageInput').value = '';
                        }
                    };
                    
                    previewWrapper.appendChild(img);
                    previewWrapper.appendChild(removeBtn);
                    previewContainer.appendChild(previewWrapper);
                };
                reader.readAsDataURL(file);
            });
        }

        document.getElementById('addProductForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (selectedFiles.length === 0) {
                document.getElementById('images-error').textContent = 'Please fill the details';
                alert('Please fill all the details');
                return;
            }
            
            const formData = new FormData(this);
          
            try {
               
                const response = await fetch('/admin/addProducts', {
                    method: 'POST',
                    body: formData
                });
                
         
                let data = await response.json();
               
                if (data.success) {
                    Swal.fire({
                        title: 'Success!',
                        text: data.message || 'Product added successfully',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = '/admin/products';
                        }
                    });
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: data.message || 'Failed to add product',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            } catch (error) {
                Swal.fire({
                    title: 'Error!',
                    text: 'Something went wrong',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
    </script>